
# Default security headers
add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"; # enable, cache, and preload subdomains
add_header X-Frame-Options "SAMEORIGIN" always; # generally only allow SAMEORIGIN frame sources
add_header X-Content-Type-Options "nosniff" always; # no sniffing allowed!
add_header Referrer-Policy "strict-origin"; # protect agains cross-linking
add_header X-Download-Options "noopen"; # force the download, and do not allow direct openning
add_header X-Permitted-Cross-Domain-Policies "none"; # protect agains cross-linking
add_header X-Robots-Tag none; # only allow robots.txt# Content Security Policy
add_header Cross-Origin-Embedder-Policy "unsafe-none";
add_header Cross-Origin-Opener-Policy "same-origin";
add_header Cross-Origin-Resource-Policy "same-site";
add_header Access-Control-Allow-Methods "GET, HEAD, POST";
add_header Access-Control-Allow-Origin "*";
set $CSP_image "img-src 'self' data: cdn.kevp.cc;"; # allowable external image domains
set $CSP_script "script-src 'self' 'unsafe-inline' cdn.jsdelivr.net kit.fontawesome.com www.google.com www.gstatic.com instant.page;"; # allowable external jaavscript domains
set $CSP_style "style-src 'self' 'unsafe-inline' cdn.jsdelivr.net;"; # allowable external CSS domains
set $CSP_font "font-src 'self' fonts.googleapis.com ka-f.fontawesome.com;"; # allowable external font domains
set $CSP_frame "frame-src 'self' www.google.com;"; # allowable external frames/iframes domains
set $CSP_object "object-src 'self';"; # allowable external object domains
set $CSP_connect "connect-src 'self' ka-f.fontawesome.com;"; # allowable external connect domains
set $CSP_media "media-src 'self' blob:;"; # allowable external media domains
set $CSP_form "form-action 'self';"; # allowable external form domains
set $CSP_frame_anc "frame-ancestors 'self';"; # allowable external frame ancestor domains
set $CSP_default "default-src 'self' kit.fontawesome.com;"; # allowable default sources
set $CSP_child "child-src 'self';";
set $CSP_manifest "manifest-src 'self';";
set $CSP_navigate "navigate-to 'self';";
set $CSP_prefetch "prefetch-src 'self';";
set $CSP_script_src_elem "script-src-elem 'self' 'unsafe-inline' cdn.jsdelivr.net kit.fontawesome.com www.google.com www.gstatic.com instant.page;";
set $CSP_script_src_attr "script-src-attr 'self' 'unsafe-inline';";
set $CSP_style_src_elem "style-src-elem 'self' 'unsafe-inline' cdn.jsdelivr.net;";
set $CSP_style_src_attr "style-src-attr 'self' 'unsafe-inline';";
set $CSP_worker "worker-src 'self';";
set $CSP "${CSP_default} ${CSP_image} ${CSP_script} ${CSP_style} ${CSP_font} ${CSP_frame} ${CSP_object} ${CSP_connect} ${CSP_media} ${CSP_form} ${CSP_frame_anc} ${CSP_child} ${CSP_manifest} ${CSP_navigate} ${CSP_prefetch} ${CSP_script_src_elem} ${CSP_script_src_attr} ${CSP_style_src_elem} ${CSP_style_src_attr} ${CSP_worker} upgrade-insecure-requests;";
add_header Content-Security-Policy $CSP always;
add_header X-Content-Security-Policy $CSP always;
add_header Permissions-Policy "interest-cohort=(self), accelerometer=(self), ambient-light-sensor=(self), autoplay=(self), camera=(self), display-capture=(self), document-domain=(self), encrypted-media=(self), execution-while-not-rendered=(self), execution-while-out-of-viewport=(self), fullscreen=(self), gamepad=(self), geolocation=(self), gyroscope=(self), magnetometer=(self), microphone=(self), midi=(self), navigation-override=(self), payment=(self), picture-in-picture=(self), publickey-credentials-get=(self), sync-xhr=(self), usb=(self), xr-spatial-tracking=(self)";
add_header Z-From "Kevin Pirnie";
add_header Z-Magician-Of "DevOps Support Lead, WordPress/Hosting";
add_header Z-Shameless-Plug "https://kevinpirnie.com/";

# pass the video streamer
location ~ ^/stream/play/(.*) {

	# pass the play to the play file
	try_files $uri $uri/ /play.php?stream=$1;

}


# pass the playlist
location ~ ^/stream/playlist.m3u {

	# only allow me
	allow 192.168.2.0/24;
    allow 75.69.182.128;
    deny all;

	# pass to index.php with the querystrings
	try_files $uri $uri/ /index.php?$args;

}

# static asset security headers
location ~* \.(?:css|scss|sass|cur|js|jpg|jpeg|webp|gif|htc|ico|png|xml|otf|ttf|eot|woff|woff2|svg|svgx|pdf|xls|xlsx|doc|json|htm|html|mp3|mp4|mkv|ogg|zip|m3u)$ {
	
	# security headers
	add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
	add_header Access-Control-Allow-Methods "GET, HEAD";
	add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Credentials 'true';
    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	add_header Expect-Ct "max-age=604800, enforce";
	add_header Content-Security-Policy "upgrade-insecure-requests;";
	add_header X-Content-Security-Policy "upgrade-insecure-requests;";
    add_header X-Content-Type-Options "nosniff";
    add_header Z-From "Kevin Pirnie";
	add_header Z-Magician-Of "DevOps Support Lead, WordPress/Hosting";
    add_header Z-Shameless-Plug "https://kevinpirnie.com/";

	# cache
    expires max;
    add_header Cache-Control public;

	# dont send cookies
	fastcgi_hide_header Set-Cookie;

    # turn off logging
	error_log off;
    log_not_found off; 
	access_log off;
	
}
